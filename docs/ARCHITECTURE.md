# Обзор архитектуры

Этот документ описывает текущее состояние Zapuskalka и ключевые архитектурные решения, которые обеспечивают MVP, определённый в `docs/PRODUCT.md`. Обновляйте файл по мере развития лаунчера, бэкенда и модели дистрибуции.

## 1. Структура проекта

```
/
├── backend/              # API на базе PocketBase, миграции, бинарные файлы
│   ├── main.go           # Инициализация PocketBase и подключения плагинов
│   ├── migrate-*.go      # Хелперы для dev/prod для переключения automigrate
│   └── migrations/       # Файлы с миграциями для PocketBase (например, games)
├── launcher/             # Десктопный клиент Wails (Go + Vue 3 + Vite)
│   ├── main.go           # Инициализация Wails и runtime bindings
│   ├── app.go            # Точка входа приложения, конфигурация окна
│   └── ui/               # SPA ассеты, бандлящиеся в десктопную оболочку
├── docs/                 # PRD, TRD и т.д.
├── scripts/              # Инструменты, такие как `typegen-watcher.ts`
├── Taskfile.yml          # Канонические задачи для dev/build (task dev, build-*)
├── package.json          # Зависимости инструментов на корневом уровне (bun, линтинг)
└── README.md             # Настройка окружения разработки и рабочего процесса
```

## 2. High-Level системная диаграмма

```
[Игрок / Разработчик]
        |
        v
[Vue SPA]
        |
        v
[Wails Desktop Launcher]
        |
        v
[PocketBase Backend API] ----> [SQLite (PocketBase data)]
        |
        +----> [S3-совместимое Object Storage]  (сборки игр, медиа)
        |
        +----> [OAuth Провайдеры: GitHub, Twitch]

```

- Лаунчер упаковывает Vue SPA внутрь оболочки Wails. Vue общается с wails через сгенерированные биндинги `wailsjs` и общается с PocketBase через PocketBase js-sdk.
- PocketBase предоставляет REST API, аутентификацию и real-time подписки, сохраняя структурированные данные в SQLite и бинарники в настроенном S3-бакете.
- Будущий проприетарный платёжный сервис (Release 3.0) будет работать рядом с PocketBase и откроет ограниченный API после появления.

## 3. Ключевые компоненты

### 3.1 Frontend

- **Название:** Zapuskalka Launcher (Wails desktop client)
- **Описание:** Кроссплатформенный десктопный UI, покрывающий MVP-цикл из PRD: аутентификация, просмотр магазина, управление библиотекой, настройка путей установки, мониторинг загрузок, запуск/обновление игр и лёгкая консоль для загрузки билдов разработчиками.
- **Технологии:** Go (Wails runtime), Vue 3 + Vite + TypeScript, PrimeVue-based дизайн‑система???, Tailwind‑подобный utility CSS (`ui/assets/main.css`), Bun‑инструментарий, PocketBase JS SDK и сгенерированные `wailsjs` биндинги.
- **Деплой:** Wails собирает нативные бандлы (`launcher/build/bin/Zapuskalka.*` для macOS и NSIS‑инсталлер/EXE для Windows). Артефакты распространяются тестерам вместе с конфигурацией эндпоинта PocketBase бэкенда???.

### 3.2 Backend Services

#### 3.2.1 PocketBase Core API

- **Описание:** Монолитный бинарник, реализующий весь backend: аутентификация (email/password, GitHub/Twitch OAuth), коллекции (games, users, libraries и т.д.), загрузка файлов, real-time обновления, используемые лаунчером. Кастомная логика может быть добавлена через PocketBase hooks/plugins.
- **Технологии:** Go 1.22+, PocketBase framework, SQLite (primary DB), S3-compatible storage (в проде, в dev можно без S3), Taskfile‑воркфлоу для dev/prod, Docker-ready бинарник.
- **Деплой:** Собранный PocketBase-бинарник (или Docker image) за HTTPS-прокси (Caddy, Nginx). `AutoMigrate` включается через build tags (`-tags automigrate`), что защищает production-данные и упрощает создание миграций на этапе разработки.

#### 3.2.2 Payment / Monetization Service (Запланирован)

- **Описание:** Проприетарный микросервис, ответственный за процессы оформления заказа (разовые покупки, pay-what-you-want, дистрибуция ключей), упомянутый в Release 3.0 PRD.
- **Технологии:** TBD (сервис будет предоставлять API, который может вызывать PocketBase); изолированный репозиторий по причинам лицензирования.
- **Деплой:** Отдельная closed-source инфраструктура; интегрируется с PocketBase через REST callbacks/webhooks.

## 4. Хранилища данных

### 4.1 PocketBase SQLite Database

- **Тип:** Встроенный SQLite (управляется PocketBase).
- **Назначение:** Основное мета‑хранилище: пользователи, токены, каталог игр, библиотеки, пути хранения, загрузки, билды разработчиков.
- **Ключевые коллекции (MVP):**
  - `_pb_users_auth_` (built-in) — игроки и разработчики, хешированные пароли, OAuth-профили.
  - `users` — основная коллекция с публичными/приватными полями профилей.
  - `games` — лёгкая коллекция с title + timestamps; далее расширится системными требованиями, медиа, прайсингом.
  - Будущие коллекции: downloads, storage libraries, purchases, developer organizations (см. PRD).

### 4.2 Object Storage

- **Тип:** S3-совместимый bucket (адаптер файлов PocketBase).
- **Назначение:** Хранит загруженные сборки игр, обложки, скриншоты и ассеты лаунчера. В dev PocketBase хранит файлы в `backend/pb_data/storage/`; production переключится на S3 путем настройки адаптера хранилища PocketBase.
- **Ключевые Buckets/Префиксы:** `_pb_users_auth_` для аватарок (уже сгенерировано), `games` для бинарных файлов/медиа (будет создано).

### 4.3 Local Cache (Launcher)

- **Тип:** Директории в файловой системе, выбранные пользователем ("Библиотеки").
- **Назначение:** Хранит установленные бинарные файлы игр, delta патчи и кэши загрузок. Управляется полностью лаунчером с метаданными.

## 5. Внешние интеграции / API

- **S3 / Object Storage:** AWS S3 совместимое хранилище.
- **OAuth Провайдеры:** GitHub & Twitch для более гладкого онбординга разработчиков/игроков; реализуются через конфигурацию OAuth провайдера в PocketBase.
- **Платежный Провайдер:** Проприетарный сервис, запланированный для Release 3.0, доступный через REST из PocketBase.
- **WebView2 (Windows) / System WebView (macOS/Linux):** Устанавливается инсталлером Wails для рендеринга Vue приложения.

## 6. Деплой и инфраструктура

- **Облако / Хостинг:** Ожидается, что PocketBase будет работать на одной VM или контейнере (например, Fly.io, Render, или bare-metal VPS). Хранилище объектов полагается на S3-совместимые сервисы (AWS S3, Cloudflare R2, Yandex Cloud и т.д.). Лаунчер распространяется в виде подписанных бинарных файлов для каждой ОС.
- **Ключевые Сервисы:** PocketBase API, S3 bucket, reverse proxy (Caddy/Nginx/Traefik и т.д.), завершающий TLS.
- **CI/CD:** Пока не настроен. Локальная автоматизация предоставляется через `Taskfile.yml` (`task dev`, `task dev-backend`, `task build-osx`, `task build-win`). Будущий CI должен покрывать линтинг, генерацию типов (`scripts/typegen-watcher.ts`), сборки лаунчера.
- **Мониторинг & Логирование:** PocketBase пишет логи в stdout.

## 7. Безопасность

- **Аутентификация:** Аутентификация PocketBase по email/паролю (bcrypt хэши) с GitHub/Twitch OAuth. Лаунчер хранит токены сессии безопасно через утилиты Pocketbase-js-sdk.
- **Авторизация:** Правила коллекций PocketBase обеспечивают контроль, кто может читать/писать игры, библиотеки и загрузки. Admin-only пути остаются за панелью управления PocketBase.
- **Шифрование данных:** Обязательный HTTPS/TLS для публичного API. SQLite должен лежать на зашифрованных томах, S3 — с включённым at-rest шифрованием и signed URLs.
- **Другие Практики:** Включение `AutoMigrate` в dev для автоматической генерации миграций в Pocketbase, валидация ввода в лаунчере перед отправкой payload.

## 8. Среда разработки и тестирования

- **Локальная Настройка:** Следуйте `/README.md`.
- **Фреймворки для Тестирования:** Пока не установлены. Frontend может использовать Vitest/Jest + Playwright; бэкенд полагается на интеграционные тесты/миграции PocketBase. Добавление линтинга/форматирования через ESLint (`launcher/ui/eslint.config.ts`) и Go fmt/vet.
- **Инструменты Качества Кода:** ESLint для Vue кодовой базы, TypeScript strict mode, валидация миграций PocketBase. Автоматические Go линтеры пока не настроены.
- **Параллельность Окружений:** Обработка `.env` сейчас ручная; Wails доставляет конфиг через `wails.json`. Для бэкенда, переменные окружения (PORT, конфигурация хранилища) должны быть подключены перед запуском в production.

## 9. Дальнейшие шаги / Roadmap

- Release 2.0 по PRD: список друзей, чат, продвинутое планирование загрузок, проверка целостности файлов.
- Release 3.0: проприетарный платежный микросервис, аналитические дашборды для разработчиков, лента новостей, гибкое ценообразование (разовое, PWYW) и управление ключами.
- Потенциальные архитектурные изменения: выделение менеджера загрузок в отдельный сервис для масштабируемости, внедрение event-driven messaging для live обновлений, миграция с единичного экземпляра PocketBase на управляемую Postgres + кастомные Go сервисы, когда требования к данным/трафику превысят ограничения MVP.

## 10. Идентификация проекта

- **Название Проекта:** Zapuskalka
- **URL Репозитория:** https://github.com/rodd-oss/zapuskalka
- **Основной Контакт / Команда:** Основные maintainers @rodd-oss (Milan Rodd) и контрибьюторы, указанные в GitHub.

## 11. Глоссарий / Аббревиатуры

- **PocketBase:** Встроенный Go бэкенд фреймворк, который объединяет аутентификацию, файловое хранилище и real-time API поверх SQLite.
- **Wails:** Go фреймворк, который встраивает современный web frontend в нативные десктопные оболочки для Windows, macOS и Linux.
- **S3:** Simple Storage Service (или совместимые провайдеры), используемые для хранения больших бинарных файлов игр и медиа ассетов.
- **PB:** Аббревиатура, используемая внутри репозитория для артефактов PocketBase (например, `pb_data`, `_pb_users_auth_`).
- **MVP:** Minimum Viable Product, как определено в `docs/PRODUCT.md`.
